name: Run Unittests
on:
    push:
        branches: [main, features/*]

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:17
                env:
                    POSTGRES_USER: test_user
                    POSTGRES_PASSWORD: test_password
                    POSTGRES_DB: test_db
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

        steps:
            - uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                python-version: "3.13"

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: Load database schema
              run: |
                PGPASSWORD=test_password psql -h localhost -U test_user -d test_db -f psql/schema.sql

            - name: Run tests
              env:
                POSTGRES_HOST: localhost
                POSTGRES_PORT: 5432
                POSTGRES_USER: test_user
                POSTGRES_PASSWORD: test_password
                POSTGRES_DB: test_db
              run: |
                python -m pytest